from zapv2 import ZAPv2
from config import config
import threading
import subprocess
import shlex
import time

###script for the zap API###


host = ''
zap = None

def __run():
    #this line means the daemon should be started:
    #[ZAP-daemon] INFO org.zaproxy.zap.DaemonBootstrap  - ZAP is now listening on
    process = subprocess.Popen(['/usr/share/zaproxy/zap.sh', '-daemon'], stdout=subprocess.PIPE)
    while True:
        output = process.stdout.readline()
        if output == '' and process.poll() is None:
            #stopped
            print('error while starting zap') #TODO better error
            break
        if output:
            print(output.decode('utf-8'), end='')
            finish = '[ZAP-daemon] INFO org.zaproxy.zap.DaemonBootstrap  - ZAP is now listening on'
            if finish in str(output):
                print('zap started succesfully')
                break

def init(thisHost):
    global zap
    global host
    host = thisHost
    __run()
    zap = ZAPv2(apikey=config.getStatic('zapApiKey'))
    zap.urlopen(host)
    print('done')

def spider():
    global host
    print('spidering')
    scanid = zap.spider.scan(host)
    time.sleep(2)
    while(int(zap.spider.status(scanid)) < 100):
        print('Spider progress: ' + zap.spider.status(scanid) + '%', end='\r')
        time.sleep(1)

    print('\nSpider is done!')
    print('\n')
    for host in zap.spider.added_nodes(scanid):
        print(host)
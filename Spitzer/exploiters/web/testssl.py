import os
from shutil import copyfile
import shlex

from Spitzer import command
from Spitzer.result.result import add
from Spitzer.config import config
from Spitzer.chache import chache

def exploit(url, _):
    if url.startswith('http://'):
        return
        
    print('testssl')
    chache.remove_file('testssl.html')
    testssl = config.get_data('testssl')
    cmd = testssl + ' --htmlfile ' + chache.get_path() + 'testssl.html ' + url
    print(cmd)
    command.run(shlex.split(cmd), capture_output=False)

    html = chache.read_file('testssl.html')

    #find the colorcodes for red and/or orange in the html
    #orange: #cdcd00
    #red: #cd0000

    if '#cdcd00' in html or '#cd0000' in html:
        if '#cd0000' in html:
            print('[*] testssl found errors') 
        else:
            print('[*] testssl gave warnings')

    
        add(url, 'testssl', 'testssl report is in ' + os.getcwd() + 'testssl.html')
        
        #copy html to working folder
        src = chache.get_path() + 'testssl.html'
        dst = os.getcwd() + '/' + 'testssl.html'
        copyfile(src, dst)
        print('[-] Placed testssl.html in ' + os.getcwd())


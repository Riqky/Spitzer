from Spitzer.exploiters import *
from Spitzer.exploiters.web import screenshot
from Spitzer.config import config
import json


def exploit(nmap):
    ports = reverse(nmap)
    modules = config.get_data('ports')

    screenshot.exploit(nmap)

    for port in ports:
        for host in ports[port]:

            if not str(port) in modules:
                continue
            module = modules[str(port)][0]
            if module != '':           
                eval(module + '.exploit(\''+ host +'\', ' + json.dumps(nmap[host]['tcp'][port]) + ',' + str(port) + ')' )



def reverse(nmap):
    result = {}

    for host in nmap:
        for port in nmap[host]['tcp']:
            if port in result:
                result[port].append(host)
            else:
                result[port] = [host]

    return result